<!doctype html>
<html>
<head>
<meta charset="UTF-8">
<title>AdaFruit PWM 1 channel</title>
<link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css" />
<link rel="stylesheet" href="common.css" />
<script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
<script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
<script src="common.js"></script>
<script>
     
	$(document).on('pagebeforeshow',function(event) {
			
					var deviceId = localStorage.getItem("deviceId");
					var deviceType = localStorage.getItem("deviceType");
			
					//get data from the server
					nocache = "&nocache=" + Math.random() * 1000000;
					var imageStr="";
					var deviceStr="";
					
						$.get( "?deviceid="+ deviceId +"&devicetype=" + deviceType + nocache,  
							function(data) {
								// grab images & color list
								$(data).find("item").each(function() {
									imageStr += '<option value="'+ $(this).find("image").text()+'">'+ $(this).find("image").text()+'</option>';
								});
							
								$('#imagemenu').append(imageStr).selectmenu("refresh",true);
								
								// grab dependent device  list
								$(data).find("device").each(function() {
									deviceStr += '<option value="'+ $(this).find("id").text()+'">'+ decodeURIComponent($(this).find("name").text()) +'</option>';
								});
								
								$('#dependentmenu').append(deviceStr).selectmenu("refresh",true);
							
							
								//****** grab device specific data & populate fields ********
								if(deviceId != 0) {	
										$('#name').val(decodeURIComponent($(data).find("deviceName").text()));
										$('#pin').val($(data).find("pin").text());
										var value = $(data).find("state").text();
									
										if(value == "0") {
											$('#status').html('<span class="led-off"></span>OFF');
										} else {
											$('#status').html('<span class="led-on"></span>ON');
										}
										
										var imageMenu = $(data).find("deviceImage").text();
										$('#imagemenu').val(imageMenu).selectmenu("refresh");
										
										var depend = $(data).find("dependent").text();
										$('#dependentmenu').val(depend).selectmenu("refresh");
										
										$('#readout').html($(data).find("readout").text());
										
										
										var events = $(data).find("event").text();
										var parts = events.split(",");
										
										//dow
											var k = 0;
											
											$("input[name='dow']").each(function(){
												var day = parts[0].charAt(k);
												if(day == "1") {
													$(this).prop("checked",true).checkboxradio("refresh");
												}
												
												k++;
											});
											
										var j = 1;
								
										for(var i=1; i < parts.length; i+=3) {
											var start = parts[i].split(":");
											$("#hour"+j).val(start[0]);
											$("#minute"+j).val(start[1]);
											$("#second"+j).val(start[2]);
											var duration = parts[i+1].split(":");
											$("#hourd"+j).val(duration[0]);
											$("#minuted"+j).val(duration[1]);
											$("#secondd"+j).val(duration[2]);
											//pwm
											$("#slider"+j).val(parts[i+2]).slider("refresh");
											j++;
										}
	
								}
	
							
							}).fail(function( jqXHR, textStatus, errorThrown ) {
								alert("Unsuccessful. See console.log for info.");
								console.log( "error: " +":"+textStatus +":"+errorThrown);
						}); // xml function
					
					
					$('input[name=slider1]').on('slidestop', function(event) {
						setPWM($(this).val());
					});
					
					$('input[name=slider2]').on('slidestop', function(event) {
						setPWM($(this).val());
					});
					
					$('input[name=slider3]').on('slidestop', function(event) {
						setPWM($(this).val());
					});
					$('input[name=slider4]').on('slidestop', function(event) {
						setPWM($(this).val());
					});
				
				
			});
			
			function setPWM(inVal) {
				var id = localStorage.getItem("deviceId");
				
				$.get("?setadapwm=" + id + "&pwm="+ inVal+"&", function(data) {
				//nothing
				});
				
				
			}
			
			
	
			function validate() {
	
				var deviceId = localStorage.getItem("deviceId");
				var deviceType = localStorage.getItem("deviceType");
				var str = "";
				
				var imageStyle = $("#imagemenu option:selected").val();

				str += "name=" + $("#name").val() + "&pin=" + $("#pin").val() + "&image=" + imageStyle +"&";
			
				var eventStr = "event=";
				var dow = "";
				$('input[name="dow"]').each(function(){
					if($(this).is(":checked")) {
						dow +="1";
					} else {
						dow +="0";
					}
				});
				
				eventStr += dow;
					
				for( var i = 1; i <= 4; i++) {
					if($("#hour"+i).val() != "") {
						
						eventStr = eventStr + "," + $("#hour"+i).val() + ":" + $("#minute"+i).val() + ":" + $("#second"+i).val();
						eventStr = eventStr + "," + $("#hourd"+i).val() + ":" + $("#minuted"+i).val() + ":" + $("#secondd"+i).val();
						eventStr = eventStr + "," + $("#slider"+i).val();
					}
				}
				
				str += eventStr;
		
		
				$.get( "?savedevice="+ deviceId +"&devicetype="+ deviceType + "&"+ str, function(data) {
					if(data != null) {
						//on complete save, go back to home
						if($(data).find("response").text() == "success") {
							location.href="index.htm";
						}
					}
					
				}).fail(function( jqXHR, textStatus, errorThrown ) {
					alert("Saving was unsuccessful. See console.log for info.");
					console.log( "error: " +":"+textStatus +":"+errorThrown);
				});
				
			}// end function
			
		
		function clearOut(inId) {
				if(confirm("Are you sure?")) {
					$("#hour"+inId+", #minute"+inId+", #second"+inId+", #hourd"+inId+", #minuted"+inId+", #secondd"+inId).val("");
					$("input[name='slider" +inId+"']").val(0).slider("refresh");
	
					
				}
			}
	
</script>

             
</head>

<body>

<div data-role="header" data-theme="b">
	<h1>Adafruit PWM</h1>
</div>

<div class="ui-body ui-grid-a ui-responsive">
        <div class="ui-block-a">
            <input name="name" type="text" id="name" placeholder="Name" value=""  maxlength="25"/> 
            <input name="pin" type="number" id="pin" placeholder="ADA PWM CHANNEL" value=""  />
            <legend>Device Status</legend>
            <p>
            <span id="status"><span class="led-off"></span>OFF</span>
            </p>
          
            
         </div>
         <div class="ui-block-b">
            <select name="dependentmenu" id="dependentmenu">
            <option value="0">Dependent device</option>
            </select>
            <select name="imagemenu" id="imagemenu">
              <option value="none.jpg">Image</option>
            </select>
            <div id="display_image"><img src="" align="center"></div>
        </div>
        
</div>

<div data-role="tabs" id="tabs">
	<div class="ui-body">
    <b>Day of the week</b>
            <fieldset data-role="controlgroup" data-type="horizontal"  data-theme="b">
                
                <input type="checkbox" name="dow" id="su1" value="su">
                <label for="su1">Su</label>
                <input type="checkbox" name="dow" id="mo1" value="mo">
                <label for="mo1">Mo</label>
                <input type="checkbox" name="dow" id="tu1" value="tu">
                <label for="tu1">Tu</label>
                <input type="checkbox" name="dow" id="we1" value="we">
                <label for="we1">We</label>
                <input type="checkbox" name="dow" id="th1" value="th">
                <label for="th1">Th</label>
                <input type="checkbox" name="dow" id="fr1" value="fr">
                <label for="fr1">Fr</label>
                <input type="checkbox" name="dow" id="sa1" value="sa">
                <label for="sa1">Sa</label>
            </fieldset>
	</div>
    <div data-role="navbar" id="navbar">
            <ul>
                <li><a href="#one" data-ajax="false" class="ui-btn-active" data-theme="b">one</a></li>
                <li><a href="#two" data-ajax="false" data-theme="b">two</a></li>
                <li><a href="#three" data-ajax="false" data-theme="b">three</a></li>
                <li><a href="#four" data-ajax="false" data-theme="b">four</a></li>
            </ul>
        </div>
        
    
  <div id="one" class="ui-body-d ui-content">
	
    <fieldset class="ui-grid-a ui-responsive">
        	<div class = "ui-block-a">
        	<b>Start</b>
         	<div class="ui-grid-b">
                <div class = "ui-block-a">
                     <input name="hour1" type="number" id="hour1" placeholder="Hour" value="" />
                </div>
                <div class = "ui-block-b">
                     <input name="minute1" type="number" id="minute1" placeholder="Minute" value="" />
                </div>
              	<div class = "ui-block-c">
                 	<input name="second1" type="number" id="second1" placeholder="Second" value="" />
              	</div>
        	</div>
           
            </div>
            <div class = "ui-block-b">
            	 <b>Duration</b>
                <div class="ui-grid-b">
                    <div class = "ui-block-a">
                         <input name="hourd1" type="number" id="hourd1" placeholder="Hour" value="" />
                    </div>
                    <div class = "ui-block-b">
                         <input name="minuted1" type="number" id="minuted1" placeholder="Minute" value="" />
                    </div>
                    <div class = "ui-block-c">
                        <input name="secondd1" type="number" id="secondd1" placeholder="Second" value="" />
                    </div>
                </div>
            </div>  
  		</fieldset>
        <div class="ui-field-contain" >
        <label for="slider">PWM</label>
        <input type="range" name="slider1" id="slider1" data-highlight="true" min="0" max="4095" value="0">
        </div>
        <a href="#" class="ui-btn ui-icon-delete ui-btn-icon-left" onClick="clearOut(1)" style="width: 55px; float: right;">RESET</a>      
  </div>

  	<div id="two" class="ui-body-d ui-content">
	
    <fieldset class="ui-grid-a ui-responsive">
        	<div class = "ui-block-a">
        	<b>Start</b>
         	<div class="ui-grid-b">
                <div class = "ui-block-a">
                     <input name="hour2" type="number" id="hour2" placeholder="Hour" value="" />
                </div>
                <div class = "ui-block-b">
                     <input name="minute2" type="number" id="minute2" placeholder="Minute" value="" />
                </div>
              	<div class = "ui-block-c">
                 	<input name="second2" type="number" id="second2" placeholder="Second" value="" />
              	</div>
        	</div>
            </div>
            <div class = "ui-block-b">
            	<b>Duration</b>
         		<div class="ui-grid-b">
                    <div class = "ui-block-a">
                         <input name="hourd2" type="number" id="hourd2" placeholder="Hour" value="" />
                    </div>
                    <div class = "ui-block-b">
                         <input name="minuted2" type="number" id="minuted2" placeholder="Minute" value="" />
                    </div>
                    <div class = "ui-block-c">
                        <input name="secondd2" type="number" id="secondd2" placeholder="Second" value="" />
                    </div>
        		</div>
            </div>    
  		</fieldset>
        <div class="ui-field-contain" >
            <label for="slider">PWM</label>
            <input type="range" name="slider2" id="slider2" data-highlight="true" min="0" max="4095" value="0">
        </div>
        <a href="#" class="ui-btn ui-icon-delete ui-btn-icon-left" onClick="clearOut(2)" style="width: 55px; float: right;">RESET</a>	 
	</div>
		<div id="three" class="ui-body-d ui-content">
    	
        <fieldset class="ui-grid-a ui-responsive">
        	<div class = "ui-block-a">
        	<b>Start</b>
         	<div class="ui-grid-b">
                <div class = "ui-block-a">
                     <input name="hour3" type="number" id="hour3" placeholder="Hour" value="" />
                </div>
                <div class = "ui-block-b">
                     <input name="minute3" type="number" id="minute3" placeholder="Minute" value="" />
                </div>
              	<div class = "ui-block-c">
                 	<input name="second3" type="number" id="second3" placeholder="Second" value="" />
              	</div>
        	</div>
            
            </div>
            <div class = "ui-block-b">
                <b>Duration</b>
                <div class="ui-grid-b">
                    <div class = "ui-block-a">
                         <input name="hourd3" type="number" id="hourd3" placeholder="Hour" value="" />
                    </div>
                    <div class = "ui-block-b">
                         <input name="minuted3" type="number" id="minuted3" placeholder="Minute" value="" />
                    </div>
                    <div class = "ui-block-c">
                        <input name="secondd3" type="number" id="secondd3" placeholder="Second" value="" />
                    </div>
                </div>
     
            </div>    
  		</fieldset>
        <div class="ui-field-contain" >
        <label for="slider">PWM</label>
        <input type="range" name="slider3" id="slider3" data-highlight="true" min="0" max="4095" value="0">
        </div>	
        <a href="#" class="ui-btn ui-icon-delete ui-btn-icon-left" onClick="clearOut(3)" style="width: 55px; float: right;">RESET</a> 
  	</div>
	<div id="four" class="ui-body-d ui-content">
    
        <fieldset class="ui-grid-a ui-responsive">
        	<div class = "ui-block-a">
        	<b>Start</b>
         	<div class="ui-grid-b">
                <div class = "ui-block-a">
                     <input name="hour4" type="number" id="hour4" placeholder="Hour" value="" />
                </div>
                <div class = "ui-block-b">
                     <input name="minute4" type="number" id="minute4" placeholder="Minute" value="" />
                </div>
              	<div class = "ui-block-c">
                 	<input name="second4" type="number" id="second4" placeholder="Second" value="" />
              	</div>
        	</div>
            
            </div>
            <div class = "ui-block-b">
      			<b>Duration</b>
                <div class="ui-grid-b">
                    <div class = "ui-block-a">
                         <input name="hourd4" type="number" id="hourd4" placeholder="Hour" value="" />
                    </div>
                    <div class = "ui-block-b">
                         <input name="minuted4" type="number" id="minuted4" placeholder="Minute" value="" />
                    </div>
                    <div class = "ui-block-c">
                        <input name="secondd4" type="number" id="secondd4" placeholder="Second" value="" />
                    </div>
                </div>
            	
            </div>    
  		</fieldset>
        <div class="ui-field-contain" >
        <label for="slider">PWM</label>
        <input type="range" name="slider4" id="slider4" data-highlight="true" min="0" max="4095" value="0">
        </div>
        <a href="#" class="ui-btn ui-icon-delete ui-btn-icon-left" onClick="clearOut(4)" style="width: 55px; float: right;">RESET</a>	 
  	</div>

</div>
    <div data-role="footer" data-position="fixed" data-id="footer" data-type="horizontal" data-tap-toggle="false" data-theme="b">
            
        <div style="text-align: center">
            <a href="#" class="ui-btn ui-icon-check ui-btn-icon-left" onClick="validate()">SAVE</a>
            <a href="#" data-ajax="false" class="ui-btn ui-icon-minus ui-btn-icon-left" onClick="cancel()">CANCEL</a>
            <a href="#" class="ui-btn ui-icon-delete ui-btn-icon-left" onClick="deleteDevice()">DELETE</a>
        </div>
            
    </div>   
 
</body>

</html>
